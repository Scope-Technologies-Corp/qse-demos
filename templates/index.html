<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QSE - QRNG Entropy Demos</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1B355E 0%, #2a4168 50%, #7F3D97 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            text-align: center;
        }

        .header-logo {
            max-width: 200px;
            height: auto;
            margin: 0 auto 20px;
            display: block;
        }

        .header-logo img {
            max-width: 100%;
            height: auto;
            max-height: 100px;
        }

        .header h1 {
            color: #7F3D97;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
            margin-top: 10px;
        }

        .demo-tabs {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-button {
            flex: 1;
            min-width: 200px;
            padding: 15px 25px;
            background: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            color: #7F3D97;
        }

        .tab-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(127, 61, 151, 0.2);
        }

        .tab-button.active {
            background: #7F3D97;
            color: white;
        }

        .demo-panel {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .demo-panel.active {
            display: block;
        }

        .demo-panel h2 {
            color: #7F3D97;
            margin-bottom: 20px;
            font-size: 2em;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .input-group input:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #7F3D97;
        }

        .input-group textarea {
            min-height: 120px;
            font-family: monospace;
            resize: vertical;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
        }

        .btn-primary {
            background: #7F3D97;
            color: white;
        }

        .btn-primary:hover {
            background: #6d3484;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(127, 61, 151, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .results {
            margin-top: 30px;
            display: none;
        }

        .results.active {
            display: block;
        }

        .result-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 4px solid #7F3D97;
        }

        .result-card h3 {
            color: #7F3D97;
            margin-bottom: 15px;
        }

        .result-item {
            margin-bottom: 12px;
            padding: 10px;
            background: white;
            border-radius: 6px;
        }

        .result-item strong {
            color: #555;
            display: inline-block;
            min-width: 200px;
        }

        .progress-bar-container {
            margin: 20px 0;
            background: #e0e0e0;
            border-radius: 10px;
            height: 30px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #1B355E, #7F3D97);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .comparison-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #e0e0e0;
        }

        .comparison-card.weak {
            border-color: #e74c3c;
        }

        .comparison-card.qrng {
            border-color: #27ae60;
        }

        .comparison-card h4 {
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .comparison-card.weak h4 {
            color: #e74c3c;
        }

        .comparison-card.qrng h4 {
            color: #27ae60;
        }

        .stat-badge {
            display: inline-block;
            padding: 8px 15px;
            background: white;
            border-radius: 20px;
            margin: 5px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .stat-badge.success {
            background: #27ae60;
            color: white;
        }

        .stat-badge.danger {
            background: #e74c3c;
            color: white;
        }

        .stat-badge.info {
            background: #3498db;
            color: white;
        }

        .chart-container {
            margin: 20px 0;
            height: 300px;
            position: relative;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #7F3D97;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-log {
            background: #0d1117;
            color: #c9d1d9;
            padding: 15px 20px;
            border-radius: 10px;
            font-family: 'JetBrains Mono', 'Fira Code', 'Courier New', monospace;
            font-size: 0.85em;
            max-height: 500px;
            overflow-y: auto;
            margin: 20px 0;
            border: 1px solid #30363d;
            line-height: 1.6;
        }

        .status-log::before {
            content: "Terminal Output";
            display: block;
            color: #8b949e;
            font-size: 0.8em;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #30363d;
        }

        .status-log-entry {
            margin: 4px 0;
            padding: 4px 8px;
            border-left: 2px solid #30363d;
            padding-left: 12px;
            animation: slideIn 0.2s ease-out;
        }

        .status-log-entry.success {
            border-left-color: #3fb950;
            color: #3fb950;
        }

        .status-log-entry.info {
            border-left-color: #58a6ff;
            color: #c9d1d9;
        }

        .status-log-entry.warning {
            border-left-color: #d29922;
            color: #d29922;
        }

        .status-log-entry.error {
            border-left-color: #f85149;
            color: #f85149;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .step {
            flex: 1;
            text-align: center;
            padding: 10px;
            position: relative;
        }

        .step::after {
            content: '';
            position: absolute;
            top: 25px;
            left: 60%;
            width: 80%;
            height: 2px;
            background: #e0e0e0;
            z-index: 1;
        }

        .step:last-child::after {
            display: none;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #999;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: bold;
            position: relative;
            z-index: 2;
            transition: all 0.3s;
        }

        .step.active .step-circle {
            background: #7F3D97;
            color: white;
            animation: pulse 1.5s infinite;
        }

        .step.completed .step-circle {
            background: #27ae60;
            color: white;
        }

        .step.completed .step-circle::before {
            content: '‚úì';
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(127, 61, 151, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(127, 61, 151, 0); }
        }

        .operation-status {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #7F3D97;
        }

        .operation-status.current {
            background: #f3e5f5;
            border-left-color: #7F3D97;
            animation: highlight 1s ease-in-out infinite;
        }

        @keyframes highlight {
            0%, 100% { background: #f3e5f5; }
            50% { background: #e1bee7; }
        }

        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            overflow-x: auto;
            margin: 10px 0;
        }

        .params-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .params-grid .input-group {
            margin-bottom: 0;
        }

        @media (max-width: 768px) {
            .comparison-grid {
                grid-template-columns: 1fr;
            }
            
            .params-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-logo">
                <img src="{{ url_for('static', filename='QSE_logo_short_Color.png') }}" alt="QSE Logo">
            </div>
            <h1>QRNG Entropy Demos</h1>
            <p>Interactive Webinar Presentation - Demonstrating the Critical Importance of Entropy Quality</p>
        </div>

        <div class="demo-tabs">
            <button class="tab-button active" onclick="showTab('entropy')">Entropy Effectiveness</button>
            <button class="tab-button" onclick="showTab('rsa')">RSA Shared Prime</button>
            <button class="tab-button" onclick="showTab('qrng-simple')">QRNG Key Derivation</button>
            <button class="tab-button" onclick="showTab('sts')">NIST STS Results</button>
        </div>

        <!-- Entropy Effectiveness Demo -->
        <div id="entropy-panel" class="demo-panel active">
            <h2>Entropy Effectiveness Demo</h2>
            
            <!-- Educational Section -->
            <div class="educational-box" style="background: #f0f7ff; border-left: 4px solid #7F3D97; padding: 20px; margin-bottom: 25px; border-radius: 8px;">
                <h3 style="color: #7F3D97; margin-bottom: 15px; font-size: 1.3em;">üìö Understanding Entropy (Simple Explanation)</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                    <div>
                        <h4 style="color: #e74c3c; margin-bottom: 10px;">‚ùå What is Weak Entropy?</h4>
                        <p style="line-height: 1.8; color: #555;">
                            <strong>Think of it like a password:</strong> If you use your birthday (like "January 15, 2024") as a password, 
                            it's easy for someone to guess because they know it's a date. <strong>Weak entropy</strong> is like using 
                            predictable information (like the current time) to create encryption keys. Attackers can easily guess it!
                        </p>
                        <p style="line-height: 1.8; color: #555; margin-top: 10px;">
                            <strong>In our demo:</strong> We use the current timestamp (like "2024-01-15 14:30:25") as the "seed" 
                            to create an encryption key. Since timestamps are predictable, attackers can try all possible timestamps 
                            in a small window and break the encryption in seconds!
                        </p>
                    </div>
                    <div>
                        <h4 style="color: #27ae60; margin-bottom: 10px;">‚úÖ What is Strong Entropy (QRNG)?</h4>
                        <p style="line-height: 1.8; color: #555;">
                            <strong>Think of it like a truly random password:</strong> Instead of using your birthday, you use a 
                            completely random string like "Xk9#mP2$qL8@nR5". No one can guess it because it's truly random. 
                            <strong>QRNG entropy</strong> uses quantum physics to generate truly unpredictable random numbers.
                        </p>
                        <p style="line-height: 1.8; color: #555; margin-top: 10px;">
                            <strong>In our demo:</strong> QRNG provides 256 bytes of completely unpredictable random data. 
                            Even if attackers know everything about the system, they can't predict what the random numbers will be. 
                            This makes brute-force attacks impossible (would take billions of years)!
                        </p>
                    </div>
                </div>
                <div style="margin-top: 20px; padding-top: 15px; border-top: 2px solid #ddd;">
                    <h4 style="color: #7F3D97; margin-bottom: 10px;">üîë Key Terms Explained:</h4>
                    <ul style="line-height: 2; color: #555; columns: 2; column-gap: 30px;">
                        <li><strong>Seed:</strong> The starting point used to create an encryption key (like a password hint)</li>
                        <li><strong>Weak Seed Space:</strong> Small number of possible seeds (like 361 timestamps) - easy to guess</li>
                        <li><strong>Strong Seed Space:</strong> Huge number of possibilities (2^256) - impossible to guess</li>
                        <li><strong>Brute-Force Attack:</strong> Trying every possible seed until finding the right one</li>
                        <li><strong>Encryption Key:</strong> The "password" used to lock/unlock your encrypted data</li>
                        <li><strong>Entropy:</strong> How unpredictable and random your seed/key material is</li>
                    </ul>
                </div>
            </div>
            
            <p style="margin-bottom: 20px; color: #666;">
                Compare weak timestamp-based entropy vs. high-quality QRNG entropy. Watch as weak seeds are brute-forced in real-time.
            </p>

            <div class="input-group">
                <label for="qrng-b64-entropy">QRNG Base64 Data (256+ bytes):</label>
                <textarea id="qrng-b64-entropy" placeholder="Paste your base64-encoded QRNG data here..."></textarea>
            </div>

            <div class="params-grid">
                <div class="input-group">
                    <label for="message-entropy">Message to Encrypt:</label>
                    <input type="text" id="message-entropy" value="Entropy matters: weak seed space collapses security.">
                </div>
                <div class="input-group">
                    <label for="window-entropy">Brute-Force Window (seconds):</label>
                    <input type="number" id="window-entropy" value="120" min="10" max="600">
                </div>
                <div class="input-group">
                    <label>
                        <input type="checkbox" id="use-system-entropy"> Use System Entropy (os.urandom) instead of Weak Timestamp
                    </label>
                </div>
            </div>

            <!-- Entropy Comparison Preview -->
            <div id="entropy-preview" style="display: none; margin: 20px 0; background: #f8f9fa; padding: 20px; border-radius: 10px; border: 2px solid #7F3D97;">
                <h3 style="color: #7F3D97; margin-bottom: 15px;">üîç What We're Comparing</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #e74c3c;">
                        <h4 style="color: #e74c3c; margin-bottom: 10px;">Weak Entropy (Timestamp)</h4>
                        <div style="font-family: monospace; font-size: 1.1em; color: #7F3D97; font-weight: bold; margin: 10px 0; text-align: center; padding: 10px; background: white; border-radius: 4px;" id="weak-entropy-display">
                            Loading...
                        </div>
                        <div style="color: #666; font-size: 0.9em; margin-top: 5px; text-align: center;">
                            Current date and time used as seed
                        </div>
                    </div>
                    <div style="background: #d4edda; padding: 15px; border-radius: 8px; border-left: 4px solid #27ae60;">
                        <h4 style="color: #27ae60; margin-bottom: 10px;">QRNG Entropy (Quantum Random)</h4>
                        <div style="font-family: monospace; font-size: 0.85em; color: #27ae60; font-weight: bold; margin: 10px 0; word-break: break-all; text-align: center; padding: 10px; background: white; border-radius: 4px; max-height: 80px; overflow-y: auto;" id="qrng-entropy-display">
                            Loading...
                        </div>
                        <div style="color: #666; font-size: 0.9em; margin-top: 5px; text-align: center;">
                            256 bytes of quantum random data used as seed
                        </div>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" onclick="runEntropyDemo()">Run Demo</button>
                <button class="btn btn-secondary" onclick="clearResults('entropy')">Clear Results</button>
            </div>

            <div id="entropy-loading" class="loading">
                <div class="spinner"></div>
                <p>Running demo... This may take a moment.</p>
            </div>

            <div id="entropy-steps" style="display: none; margin: 20px 0;"></div>

            <div id="entropy-status" class="status-log" style="display: none;"></div>

            <!-- Attack Visualization -->
            <div id="entropy-attack-visualization" style="display: none; margin: 20px 0;">
                <div class="result-card" style="background: #fff3cd; border-left-color: #f39c12;">
                    <h3 style="color: #856404;">üîç Live Attack Visualization</h3>
                    <div style="margin: 15px 0;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <div><strong>What's happening:</strong> The attacker is trying different timestamps (seeds) to find the right one</div>
                            <div id="attack-current-seed" style="font-family: monospace; color: #7F3D97; font-weight: bold;"></div>
                        </div>
                        <div id="attack-seeds-tried" style="max-height: 150px; overflow-y: auto; background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 0.9em;">
                            <div style="color: #999; margin-bottom: 10px;">Seeds being tried (timestamps):</div>
                            <div id="attack-seeds-list"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="entropy-progress" style="display: none; margin: 20px 0;">
                <div class="progress-bar-container">
                    <div class="progress-bar" id="entropy-progress-bar" style="width: 0%">0%</div>
                </div>
                <div id="entropy-progress-text" style="text-align: center; margin-top: 10px;"></div>
            </div>

            <div id="entropy-results" class="results"></div>
        </div>

        <!-- RSA Demo -->
        <div id="rsa-panel" class="demo-panel">
            <h2>RSA Shared Prime Demo</h2>
            <p style="margin-bottom: 20px; color: #666;">
                Generate RSA keys with weak vs. QRNG entropy and detect shared prime factors that compromise security.
            </p>

            <div class="input-group">
                <label for="qrng-b64-rsa">QRNG Base64 Data (256+ bytes):</label>
                <textarea id="qrng-b64-rsa" placeholder="Paste your base64-encoded QRNG data here..."></textarea>
            </div>

            <div class="params-grid">
                <div class="input-group">
                    <label for="count-rsa">Number of Keys:</label>
                    <input type="number" id="count-rsa" value="200" min="50" max="1000">
                </div>
                <div class="input-group">
                    <label for="bits-rsa">RSA Modulus Bits:</label>
                    <input type="number" id="bits-rsa" value="512" min="256" step="64">
                </div>
                <div class="input-group">
                    <label for="seed-space-rsa">Weak Seed Space (bits):</label>
                    <input type="number" id="seed-space-rsa" value="12" min="8" max="20">
                </div>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" onclick="runRSADemo()">Run Demo</button>
                <button class="btn btn-secondary" onclick="clearResults('rsa')">Clear Results</button>
            </div>

            <div id="rsa-loading" class="loading">
                <div class="spinner"></div>
                <p>Generating RSA keys... This may take a moment.</p>
            </div>

            <div id="rsa-steps" style="display: none; margin: 20px 0;"></div>

            <div id="rsa-status" class="status-log" style="display: none;"></div>

            <div id="rsa-progress" style="display: none; margin: 20px 0;">
                <div class="progress-bar-container">
                    <div class="progress-bar" id="rsa-progress-bar" style="width: 0%">0%</div>
                </div>
                <div id="rsa-progress-text" style="text-align: center; margin-top: 10px;"></div>
            </div>

            <div id="rsa-results" class="results"></div>
        </div>

        <!-- QRNG Simple Demo -->
        <div id="qrng-simple-panel" class="demo-panel">
            <h2>QRNG Key Derivation Demo</h2>
            <p style="margin-bottom: 20px; color: #666;">
                Simple demonstration of deriving a cryptographic key from QRNG data and encrypting a message.
            </p>

            <div class="input-group">
                <label for="qrng-b64-simple">QRNG Base64 Data (256+ bytes):</label>
                <textarea id="qrng-b64-simple" placeholder="Paste your base64-encoded QRNG data here..."></textarea>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" onclick="runQRNGSimple()">Run Demo</button>
                <button class="btn btn-secondary" onclick="clearResults('qrng-simple')">Clear Results</button>
            </div>

            <div id="qrng-simple-loading" class="loading">
                <div class="spinner"></div>
                <p>Deriving key and encrypting...</p>
            </div>

            <div id="qrng-simple-steps" style="display: none; margin: 20px 0;"></div>

            <div id="qrng-simple-status" class="status-log" style="display: none;"></div>

            <div id="qrng-simple-results" class="results"></div>
        </div>

        <!-- NIST STS Demo -->
        <div id="sts-panel" class="demo-panel">
            <h2>NIST STS Entropy Comparison</h2>
            <p style="margin-bottom: 20px; color: #666;">
                View NIST Statistical Test Suite (SP 800-22) results comparing QSE quantum entropy vs. system entropy.
            </p>

            <div id="sts-loading" class="loading">
                <div class="spinner"></div>
                <p>Loading STS results...</p>
            </div>

            <div id="sts-status" class="status-log" style="display: none;"></div>

            <div id="sts-results" class="results" style="display: none;">
                <!-- Scorecard will be rendered here -->
            </div>

            <!-- Report link - shown after successful run or when results exist -->
            <div id="sts-report-link" style="display: none; margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); border: 2px solid #28a745; border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(40,167,69,0.2);">
                <div style="font-size: 2em; margin-bottom: 10px;">üìä</div>
                <strong style="color: #155724; font-size: 1.1em;">NIST STS Report Available</strong>
                <p style="color: #155724; margin: 10px 0; font-size: 0.9em;">View the complete HTML scorecard with detailed test results</p>
                <a href="/api/sts/report-html" target="_blank" class="btn btn-primary" style="background: #28a745; border-color: #28a745; display: inline-block; padding: 12px 30px; font-size: 1.1em;">
                    üìÑ Open Full HTML Report
                </a>
            </div>

            <div id="sts-run-tests" style="margin-top: 30px; display: none;">
                <div class="result-card">
                    <h3>Run New STS Tests</h3>
                    <p style="margin-bottom: 20px; color: #666;">
                        Generate new entropy sequences and run NIST STS tests. This may take several minutes.
                    </p>

                    <div class="params-grid">
                        <div class="input-group">
                            <label for="sts-sequences">Number of Sequences:</label>
                            <input type="number" id="sts-sequences" value="100" min="10" max="1000">
                        </div>
                        <div class="input-group">
                            <label for="sts-seq-length">Sequence Length (bits):</label>
                            <input type="number" id="sts-seq-length" value="1000000" min="100000" max="10000000" step="100000">
                        </div>
                    </div>

                    <div class="input-group" id="sts-endpoint-group" style="margin-top: 15px;">
                        <label for="sts-endpoint">QSE Entropy API Endpoint:</label>
                        <div style="position: relative; display: flex; align-items: center;">
                            <input type="password" id="sts-endpoint" placeholder="http://api.example.com:8888/entropy" autocomplete="off" style="flex: 1; padding-right: 45px;" value="">
                            <button type="button" id="sts-endpoint-toggle" onclick="toggleEndpointVisibility()" style="position: absolute; right: 10px; background: none; border: none; cursor: pointer; font-size: 1.2em; color: #7F3D97; padding: 5px;" title="Show/Hide endpoint">
                                üëÅÔ∏è
                            </button>
                        </div>
                        <small style="display: block; margin-top: 5px; color: #666;">API format: endpoint/get/125k (script adds /get automatically)</small>
                    </div>
                    
                    <div class="alert" style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 10px 15px; margin-top: 15px; font-size: 0.9em;">
                        <strong>‚è±Ô∏è Note:</strong> The pipeline generates both QSE and System entropy, runs NIST STS (15 statistical tests), and compares results. This takes approximately <strong>10-30 minutes</strong> for 100 sequences.
                    </div>

                    <div class="button-group" style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="runSTSTests()">üöÄ Run Full Pipeline</button>
                        <button class="btn btn-secondary" onclick="loadSTSResults()">üìä Reload Results</button>
                    </div>

                    <div id="sts-test-progress" style="display: none; margin-top: 20px;">
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="sts-test-progress-bar" style="width: 0%">0%</div>
                        </div>
                        <div id="sts-test-progress-text" style="text-align: center; margin-top: 10px; color: #666;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Toggle endpoint visibility
        function toggleEndpointVisibility() {
            const input = document.getElementById('sts-endpoint');
            const button = document.getElementById('sts-endpoint-toggle');
            if (input.type === 'password') {
                input.type = 'text';
                button.textContent = 'üôà';
            } else {
                input.type = 'password';
                button.textContent = 'üëÅÔ∏è';
            }
        }

        // Tab switching
        let stsTabLoaded = false;
        function showTab(tabName) {
            // Hide all panels
            document.querySelectorAll('.demo-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            
            // Remove active from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected panel
            document.getElementById(tabName + '-panel').classList.add('active');
            
            // Activate button
            event.target.classList.add('active');
            
            // Auto-load STS results when STS tab is first shown
            if (tabName === 'sts' && !stsTabLoaded) {
                stsTabLoaded = true;
                setTimeout(() => loadSTSResults(), 100);
            }
        }

        // Clear results
        function clearResults(demoType) {
            // Clear results
            const resultsDiv = document.getElementById(demoType + '-results');
            resultsDiv.innerHTML = '';
            resultsDiv.classList.remove('active');
            
            // Clear status log
            const statusLog = document.getElementById(demoType + '-status');
            if (statusLog) {
                statusLog.innerHTML = '';
                statusLog.style.display = 'none';
            }
            
            // Clear and hide progress bar
            const progress = document.getElementById(demoType + '-progress');
            if (progress) {
                progress.style.display = 'none';
                const progressBar = document.getElementById(demoType + '-progress-bar');
                if (progressBar) {
                    progressBar.style.width = '0%';
                    progressBar.textContent = '0%';
                }
                const progressText = document.getElementById(demoType + '-progress-text');
                if (progressText) {
                    progressText.textContent = '';
                }
            }
            
            // Hide step indicators
            const stepsContainer = document.getElementById(demoType + '-steps');
            if (stepsContainer) {
                stepsContainer.innerHTML = '';
                stepsContainer.style.display = 'none';
            }
            
            // Hide attack visualization
            const attackViz = document.getElementById(demoType + '-attack-visualization');
            if (attackViz) {
                attackViz.style.display = 'none';
            }
            
            // Hide entropy preview
            const entropyPreview = document.getElementById(demoType + '-preview');
            if (entropyPreview) {
                entropyPreview.style.display = 'none';
            }
            
            // Hide loading spinner
            const loading = document.getElementById(demoType + '-loading');
            if (loading) {
                loading.classList.remove('active');
            }
        }

        // Status log helper
        function addStatusLog(containerId, message, type = 'info', showTimestamp = true) {
            const container = document.getElementById(containerId);
            const entry = document.createElement('div');
            entry.className = `status-log-entry ${type}`;
            if (showTimestamp) {
                const timestamp = new Date().toLocaleTimeString();
                entry.textContent = `[${timestamp}] ${message}`;
            } else {
                entry.textContent = message;
            }
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        // Step indicator helper
        function updateStepIndicator(containerId, steps, currentStep) {
            const container = document.getElementById(containerId);
            let html = '<div class="step-indicator">';
            steps.forEach((step, index) => {
                let stepClass = '';
                if (index < currentStep) stepClass = 'completed';
                else if (index === currentStep) stepClass = 'active';
                html += `<div class="step ${stepClass}">`;
                html += `<div class="step-circle">${index + 1}</div>`;
                html += `<div>${step}</div>`;
                html += '</div>';
            });
            html += '</div>';
            container.innerHTML = html;
        }

        // Entropy Demo
        async function runEntropyDemo() {
            const qrngB64 = document.getElementById('qrng-b64-entropy').value.trim();
            const message = document.getElementById('message-entropy').value;
            const window = parseInt(document.getElementById('window-entropy').value);
            const useSystem = document.getElementById('use-system-entropy').checked;

            if (!qrngB64) {
                alert('Please provide QRNG base64 data');
                return;
            }

            const loading = document.getElementById('entropy-loading');
            const results = document.getElementById('entropy-results');
            const progress = document.getElementById('entropy-progress');
            const statusLog = document.getElementById('entropy-status');
            const stepsContainer = document.getElementById('entropy-steps');
            
            // Clear previous logs
            statusLog.innerHTML = '';
            statusLog.style.display = 'block';
            stepsContainer.style.display = 'block';
            
            loading.classList.add('active');
            results.classList.remove('active');
            progress.style.display = 'none';

            // Setup steps
            const steps = useSystem ? 
                ['Parse QRNG Data', 'Generate System Entropy Key', 'Generate QRNG Key', 'Encrypt Messages', 'Analyze Results'] :
                ['Parse QRNG Data', 'Generate Weak Entropy Key', 'Generate QRNG Key', 'Encrypt Messages', 'Brute-Force Attack', 'Analyze Results'];
            updateStepIndicator('entropy-steps', steps, 0);

            try {
                // Show entropy preview
                const entropyPreview = document.getElementById('entropy-preview');
                const weakEntropyDisplay = document.getElementById('weak-entropy-display');
                const qrngEntropyDisplay = document.getElementById('qrng-entropy-display');
                
                if (!useSystem) {
                    // Show current timestamp as weak entropy
                    const now = new Date();
                    const timestamp = Math.floor(now.getTime() / 1000);
                    const timestampReadable = now.toLocaleString('en-US', { 
                        year: 'numeric', 
                        month: '2-digit', 
                        day: '2-digit', 
                        hour: '2-digit', 
                        minute: '2-digit', 
                        second: '2-digit',
                        hour12: false 
                    });
                    weakEntropyDisplay.textContent = timestampReadable;
                    weakEntropyDisplay.title = `Unix timestamp: ${timestamp}`;
                    weakEntropyDisplay.parentElement.querySelector('div[style*="color: #666"]').textContent = 'Current date and time used as seed';
                } else {
                    weakEntropyDisplay.textContent = 'System entropy (os.urandom)';
                    weakEntropyDisplay.parentElement.querySelector('div[style*="color: #666"]').textContent = '4 random bytes from operating system';
                }
                
                // Show QRNG data preview
                if (qrngB64.length > 0) {
                    const preview = qrngB64.substring(0, 80) + '...';
                    qrngEntropyDisplay.textContent = preview;
                    qrngEntropyDisplay.title = `Full QRNG data: ${qrngB64.length} characters`;
                } else {
                    qrngEntropyDisplay.textContent = 'No QRNG data provided';
                }
                
                entropyPreview.style.display = 'block';
                
                addStatusLog('entropy-status', 'Starting entropy effectiveness demo...', 'info');
                addStatusLog('entropy-status', `Entropy type: ${useSystem ? 'System (os.urandom)' : 'Weak (timestamp)'}`, 'info');
                addStatusLog('entropy-status', `Message: "${message}"`, 'info');
                addStatusLog('entropy-status', `Brute-force window: ¬±${window} seconds`, 'info');

                updateStepIndicator('entropy-steps', steps, 1);
                addStatusLog('entropy-status', 'Parsing QRNG base64 data...', 'info');
                await new Promise(r => setTimeout(r, 300));

                updateStepIndicator('entropy-steps', steps, 2);
                addStatusLog('entropy-status', useSystem ? 'Generating system entropy key (os.urandom)...' : 'Generating weak entropy key from timestamp...', 'info');
                await new Promise(r => setTimeout(r, 300));

                updateStepIndicator('entropy-steps', steps, 3);
                addStatusLog('entropy-status', 'Generating QRNG entropy key (HKDF-SHA256)...', 'info');
                await new Promise(r => setTimeout(r, 300));

                updateStepIndicator('entropy-steps', steps, 4);
                addStatusLog('entropy-status', 'Encrypting messages with AES-GCM...', 'info');

                let response;
                try {
                    response = await fetch('/api/entropy-demo', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            qrng_b64: qrngB64,
                            message: message,
                            window: window,
                            use_system_entropy: useSystem
                        })
                    });
                } catch (networkError) {
                    throw new Error(`Network error: ${networkError.message}. Please check if the server is running.`);
                }

                // Check if response is ok before parsing
                if (!response.ok) {
                    let errorMessage = 'Demo failed';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error || `Server error (${response.status}): ${response.statusText}`;
                    } catch (e) {
                        errorMessage = `Server error (${response.status}): ${response.statusText}`;
                    }
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                
                addStatusLog('entropy-status', 'Encryption completed', 'success');
                
                // Store interval reference to clear it later
                let progressInterval = null;
                
                // Update weak entropy display with actual timestamp used (after data is available)
                if (!useSystem && data.system_packet && data.system_packet.seed_timestamp) {
                    weakEntropyDisplay.textContent = data.system_packet.seed_timestamp;
                    weakEntropyDisplay.style.color = '#e74c3c';
                }
                
                if (!useSystem) {
                    updateStepIndicator('entropy-steps', steps, 5);
                    addStatusLog('entropy-status', `Starting brute-force attack (searching ¬±${window} seconds)...`, 'warning');
                    progress.style.display = 'block';
                    
                    // Show initial progress
                    let progressBar = document.getElementById('entropy-progress-bar');
                    let progressText = document.getElementById('entropy-progress-text');
                    progressBar.style.width = '5%';
                    progressBar.textContent = '5%';
                    progressText.textContent = 'Starting brute-force attack...';
                    
                    // Update progress periodically during attack
                    progressInterval = setInterval(() => {
                        // This would be updated by real progress data if we had streaming
                        progressText.textContent = 'Brute-forcing weak seed... Testing timestamps...';
                    }, 500);
                }
                
                // Clear the progress interval if it was set
                if (progressInterval) {
                    clearInterval(progressInterval);
                }

                // Show progress updates if available and update to completion
                if (!useSystem) {
                    const attackViz = document.getElementById('entropy-attack-visualization');
                    const seedsList = document.getElementById('attack-seeds-list');
                    const currentSeedDisplay = document.getElementById('attack-current-seed');
                    let progressBar = document.getElementById('entropy-progress-bar');
                    let progressText = document.getElementById('entropy-progress-text');
                    
                    attackViz.style.display = 'block';
                    
                    if (data.progress_updates && data.progress_updates.length > 0) {
                        // Show all progress updates with seeds being tried
                        seedsList.innerHTML = '';
                        data.progress_updates.forEach((update, idx) => {
                            if (update.current_seed) {
                                const seedDiv = document.createElement('div');
                                seedDiv.style.padding = '5px';
                                seedDiv.style.borderBottom = '1px solid #333';
                                seedDiv.innerHTML = `<span style="color: #999;">Attempt ${update.guesses}:</span> <span style="color: #4CAF50;">Trying timestamp: ${update.current_seed.timestamp}</span> <span style="color: #999;">(Seed: ${update.current_seed.seed})</span>`;
                                seedsList.appendChild(seedDiv);
                            }
                        });
                        
                        // Show the last progress update
                        const lastUpdate = data.progress_updates[data.progress_updates.length - 1];
                        const progressPercent = Math.min(100, parseFloat(lastUpdate.progress.toFixed(1)));
                        progressBar.style.width = progressPercent + '%';
                        progressBar.textContent = progressPercent.toFixed(1) + '%';
                        
                        if (lastUpdate.current_seed) {
                            currentSeedDisplay.textContent = `Currently trying: ${lastUpdate.current_seed.timestamp}`;
                        }
                        
                        progressText.textContent = 
                            `Testing seed ${lastUpdate.guesses.toLocaleString()} / ${lastUpdate.total.toLocaleString()} (${lastUpdate.rate.toFixed(0)} guesses/sec)`;
                    }
                    
                    // Always show 100% completion when results are ready
                    setTimeout(() => {
                        progressBar.style.width = '100%';
                        progressBar.textContent = '100%';
                        if (data.attack_result.success) {
                            progressText.textContent = `‚úì Attack completed successfully! Found seed in ${data.attack_result.guesses.toLocaleString()} guesses (${data.attack_result.elapsed_sec.toFixed(4)}s)`;
                            if (data.attack_result.recovered_seed_timestamp) {
                                currentSeedDisplay.textContent = `‚úì Found! Seed: ${data.attack_result.recovered_seed_timestamp}`;
                                currentSeedDisplay.style.color = '#27ae60';
                            }
                        } else {
                            progressText.textContent = `Attack completed: Tested ${data.attack_result.guesses.toLocaleString()} seeds (${data.attack_result.elapsed_sec.toFixed(4)}s) - No match found`;
                        }
                    }, 100);
                }

                if (!useSystem && data.attack_result.success) {
                    addStatusLog('entropy-status', `‚úì Attack successful! Seed recovered: ${data.attack_result.recovered_seed}`, 'success');
                    addStatusLog('entropy-status', `Recovered plaintext: "${data.attack_result.recovered_plaintext.split('|')[1] || data.attack_result.recovered_plaintext}"`, 'success');
                    addStatusLog('entropy-status', `Total guesses: ${data.attack_result.guesses.toLocaleString()} in ${data.attack_result.elapsed_sec.toFixed(4)}s`, 'success');
                } else if (!useSystem) {
                    addStatusLog('entropy-status', '‚úó Attack failed within the specified window', 'error');
                }

                updateStepIndicator('entropy-steps', steps, steps.length - 1);
                addStatusLog('entropy-status', 'Calculating work factors and security analysis...', 'info');
                await new Promise(r => setTimeout(r, 300));

                addStatusLog('entropy-status', 'Demo completed successfully!', 'success');
                
                // Hide progress after a short delay to show completion
                if (!useSystem && progress.style.display !== 'none') {
                    setTimeout(() => {
                        // Keep progress visible but show final state
                        const progressText = document.getElementById('entropy-progress-text');
                        if (data.attack_result.success) {
                            progressText.style.fontWeight = 'bold';
                            progressText.style.color = '#27ae60';
                        }
                    }, 2000);
                } else if (useSystem) {
                    // Hide progress for system entropy mode
                    progress.style.display = 'none';
                }
                
                displayEntropyResults(data);
            } catch (error) {
                addStatusLog('entropy-status', `‚úó Error: ${error.message}`, 'error');
                results.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
                results.classList.add('active');
            } finally {
                loading.classList.remove('active');
            }
        }

        function displayEntropyResults(data) {
            const results = document.getElementById('entropy-results');
            const attack = data.attack_result;
            const workFactors = data.work_factors;

            let html = '<div class="result-card">';
            html += '<h3>üîç Attack Results - What Just Happened?</h3>';
            
            if (data.entropy_type === 'weak') {
                html += `<div class="result-item"><strong>Attack Status:</strong> <span class="stat-badge ${attack.success ? 'success' : 'danger'}">${attack.success ? '‚úÖ SUCCESS - Encryption Broken!' : '‚ùå FAILED'}</span></div>`;
                
                if (attack.success) {
                    html += `<div class="result-item" style="background: #d4edda; padding: 15px; border-radius: 8px; margin: 10px 0;">`;
                    html += `<strong style="color: #155724;">‚úÖ What the Attacker Found:</strong><br>`;
                    html += `<div style="margin-top: 10px;"><strong>Recovered Seed (Timestamp):</strong> ${attack.recovered_seed_timestamp || attack.recovered_seed}</div>`;
                    html += `<div style="margin-top: 10px;"><strong>Recovered Secret Message:</strong> <span style="font-family: monospace; background: white; padding: 5px; border-radius: 4px;">${attack.recovered_plaintext.split('|')[1] || attack.recovered_plaintext}</span></div>`;
                    html += `<div style="margin-top: 10px; color: #155724; font-weight: bold;">The attacker successfully broke the encryption by guessing the timestamp!</div>`;
                    html += `</div>`;
                }
                
                html += `<div class="result-item"><strong>How Many Guesses:</strong> ${attack.guesses.toLocaleString()} timestamps tried</div>`;
                html += `<div class="result-item"><strong>Time to Break:</strong> ${attack.elapsed_sec.toFixed(4)} seconds (less than a blink of an eye!)</div>`;
                html += `<div class="result-item"><strong>Guessing Speed:</strong> ${attack.guesses_per_sec.toLocaleString()} guesses per second</div>`;
                html += `<div class="result-item"><strong>Search Space (How Many Possibilities):</strong> ${attack.search_space_size.toLocaleString()} timestamps (only ${attack.search_space_bits.toFixed(2)} bits of security)</div>`;
                
                if (attack.start_timestamp && attack.end_timestamp) {
                    html += `<div class="result-item" style="background: #f8f9fa; padding: 10px; border-radius: 6px; margin-top: 10px;">`;
                    html += `<strong>Attack Window:</strong> From ${attack.start_timestamp} to ${attack.end_timestamp}<br>`;
                    html += `<small style="color: #666;">The attacker only had to try timestamps in this 2-minute window</small>`;
                    html += `</div>`;
                }
            } else {
                html += `<div class="result-item"><strong>Entropy Type:</strong> System Entropy (os.urandom)</div>`;
                html += `<div class="result-item"><strong>Seed Space:</strong> 2^${attack.search_space_bits.toFixed(0)} = ${attack.search_space_size.toLocaleString()} possibilities</div>`;
                html += `<div class="result-item"><strong>Security Level:</strong> ${attack.search_space_bits.toFixed(0)} bits</div>`;
            }
            html += '</div>';

            html += '<div class="comparison-grid">';
            
            // Weak/System case
            html += '<div class="comparison-card ' + (data.entropy_type === 'weak' ? 'weak' : 'info') + '">';
            html += `<h4>${data.entropy_type === 'weak' ? 'Weak Entropy (Timestamp)' : 'System Entropy'}</h4>`;
            if (data.entropy_type === 'weak' && data.system_packet.seed_timestamp) {
                html += `<div class="result-item" style="background: #fff3cd; padding: 15px; border-radius: 6px; margin-bottom: 15px; border: 2px solid #e74c3c;">`;
                html += `<strong style="color: #856404; display: block; margin-bottom: 10px;">Entropy Used:</strong>`;
                html += `<div style="font-family: monospace; font-size: 1.3em; color: #e74c3c; font-weight: bold; text-align: center; padding: 10px; background: white; border-radius: 4px; margin: 10px 0;">${data.system_packet.seed_timestamp}</div>`;
                html += `<div style="font-size: 0.85em; color: #999; margin-top: 5px; text-align: center;">Unix timestamp: ${data.system_packet.seed_hint}</div>`;
                html += `</div>`;
            }
            html += `<div class="result-item"><strong>Search Space (Possibilities):</strong> ${workFactors.weak.search_space_bits.toFixed(2)} bits = ${Math.pow(2, workFactors.weak.search_space_bits).toLocaleString()} possibilities</div>`;
            html += `<div class="result-item"><strong>Time to Break:</strong> <span style="color: #e74c3c; font-weight: bold;">${workFactors.weak.expected_time_human}</span></div>`;
            html += '</div>';

            // QRNG case
            html += '<div class="comparison-card qrng">';
            html += '<h4>QRNG Entropy (Quantum Random)</h4>';
            html += `<div class="result-item" style="background: #d4edda; padding: 15px; border-radius: 6px; margin-bottom: 15px; border: 2px solid #27ae60;">`;
            html += `<strong style="color: #155724; display: block; margin-bottom: 10px;">Entropy Used:</strong>`;
            html += `<div style="font-family: monospace; font-size: 0.9em; color: #27ae60; font-weight: bold; text-align: center; padding: 10px; background: white; border-radius: 4px; margin: 10px 0; word-break: break-all; max-height: 100px; overflow-y: auto;">256 bytes of quantum random data</div>`;
            html += `<div style="font-size: 0.85em; color: #999; margin-top: 5px; text-align: center;">2,048 bits of quantum randomness</div>`;
            html += `</div>`;
            html += `<div class="result-item"><strong>Raw Bits:</strong> ${workFactors.qrng.raw_bits} bits</div>`;
            html += `<div class="result-item"><strong>Conditioned Key:</strong> ${workFactors.qrng.conditioned_bits.toFixed(0)} bits</div>`;
            html += `<div class="result-item"><strong>Time to Break:</strong> <span style="color: #27ae60; font-weight: bold;">${workFactors.qrng.expected_time_human}</span></div>`;
            html += `<div class="result-item" style="color: #27ae60; font-weight: bold; margin-top: 10px;">‚úÖ SECURE - Impossible to break!</div>`;
            html += '</div>';

            html += '</div>';
            
            // Add educational comparison
            html += '<div class="result-card" style="background: #e3f2fd; border-left-color: #2196F3; margin-top: 20px;">';
            html += '<h3 style="color: #1976D2;">üí° Key Takeaway</h3>';
            html += '<div style="line-height: 1.8; color: #555;">';
            html += '<p><strong>The same encryption (AES-256) was used in both cases.</strong> The difference is the entropy source:</p>';
            html += '<ul style="margin-left: 20px; margin-top: 10px;">';
            html += '<li><strong>Weak Entropy (Timestamp):</strong> Predictable ‚Üí Easy to guess ‚Üí Encryption broken in seconds</li>';
            html += '<li><strong>QRNG Entropy:</strong> Unpredictable ‚Üí Impossible to guess ‚Üí Encryption remains secure</li>';
            html += '</ul>';
            html += '<p style="margin-top: 15px; font-weight: bold; color: #1976D2;">This proves: <strong>No encryption can protect you if your entropy source is weak!</strong></p>';
            html += '</div>';
            html += '</div>';

            // Key fingerprints
            html += '<div class="result-card">';
            html += '<h3>Key Fingerprints</h3>';
            html += `<div class="result-item"><strong>${data.system_packet.scheme} Key:</strong> <code>${data.system_packet.key_fingerprint}</code></div>`;
            html += `<div class="result-item"><strong>QRNG Key:</strong> <code>${data.qrng_packet.key_fingerprint}</code></div>`;
            html += '</div>';

            results.innerHTML = html;
            results.classList.add('active');
        }

        // RSA Demo
        async function runRSADemo() {
            const qrngB64 = document.getElementById('qrng-b64-rsa').value.trim();
            const count = parseInt(document.getElementById('count-rsa').value);
            const bits = parseInt(document.getElementById('bits-rsa').value);
            const seedSpace = parseInt(document.getElementById('seed-space-rsa').value);

            if (!qrngB64) {
                alert('Please provide QRNG base64 data');
                return;
            }

            const loading = document.getElementById('rsa-loading');
            const results = document.getElementById('rsa-results');
            const statusLog = document.getElementById('rsa-status');
            const stepsContainer = document.getElementById('rsa-steps');
            const progress = document.getElementById('rsa-progress');
            
            // Clear previous logs
            statusLog.innerHTML = '';
            statusLog.style.display = 'block';
            stepsContainer.style.display = 'block';
            
            loading.classList.add('active');
            results.classList.remove('active');
            progress.style.display = 'none';

            const steps = ['Parse QRNG Data', 'Generate Weak Entropy Keys', 'Generate QRNG Keys', 'Scan for Shared Factors', 'Analyze Vulnerabilities'];
            updateStepIndicator('rsa-steps', steps, 0);

            try {
                addStatusLog('rsa-status', 'Starting RSA shared prime demo...', 'info');
                addStatusLog('rsa-status', `Configuration: ${count} keys, ${bits}-bit RSA modulus, ${seedSpace}-bit weak seed space`, 'info');

                updateStepIndicator('rsa-steps', steps, 1);
                addStatusLog('rsa-status', 'Parsing QRNG base64 data (256 bytes)...', 'info');
                await new Promise(r => setTimeout(r, 300));

                updateStepIndicator('rsa-steps', steps, 2);
                addStatusLog('rsa-status', `Generating ${count} weak entropy RSA keys (this may take a moment)...`, 'warning');
                progress.style.display = 'block';
                document.getElementById('rsa-progress-bar').style.width = '20%';
                document.getElementById('rsa-progress-text').textContent = 'Generating weak entropy keys...';
                
                const response = await fetch('/api/rsa-demo', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        qrng_b64: qrngB64,
                        count: count,
                        bits: bits,
                        seed_space_bits: seedSpace
                    })
                });

                const data = await response.json();
                
                document.getElementById('rsa-progress-bar').style.width = '60%';
                document.getElementById('rsa-progress-text').textContent = 'Generating QRNG keys...';
                addStatusLog('rsa-status', `Generated ${count} weak entropy keys in ${data.weak_keys.generation_time.toFixed(2)}s`, 'success');
                
                updateStepIndicator('rsa-steps', steps, 3);
                addStatusLog('rsa-status', `Generating ${count} QRNG entropy RSA keys...`, 'info');
                
                if (!response.ok) {
                    throw new Error(data.error || 'Demo failed');
                }

                document.getElementById('rsa-progress-bar').style.width = '80%';
                document.getElementById('rsa-progress-text').textContent = 'Scanning for shared factors...';
                addStatusLog('rsa-status', `Generated ${count} QRNG keys in ${data.qrng_keys.generation_time.toFixed(2)}s`, 'success');
                addStatusLog('rsa-status', 'Scanning weak entropy keys for shared prime factors...', 'warning');
                
                await new Promise(r => setTimeout(r, 300));
                addStatusLog('rsa-status', `Found ${data.weak_keys.vulnerable_count} vulnerable keys out of ${count}`, data.weak_keys.vulnerable_count > 0 ? 'error' : 'success');
                addStatusLog('rsa-status', 'Scanning QRNG keys for shared prime factors...', 'info');
                
                await new Promise(r => setTimeout(r, 300));
                addStatusLog('rsa-status', `Found ${data.qrng_keys.vulnerable_count} vulnerable keys out of ${count}`, data.qrng_keys.vulnerable_count > 0 ? 'error' : 'success');

                updateStepIndicator('rsa-steps', steps, 4);
                document.getElementById('rsa-progress-bar').style.width = '100%';
                document.getElementById('rsa-progress-text').textContent = 'Analysis complete!';
                addStatusLog('rsa-status', 'Analysis completed successfully!', 'success');

                displayRSAResults(data);
            } catch (error) {
                addStatusLog('rsa-status', `‚úó Error: ${error.message}`, 'error');
                results.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
                results.classList.add('active');
            } finally {
                loading.classList.remove('active');
                progress.style.display = 'none';
            }
        }

        function displayRSAResults(data) {
            const results = document.getElementById('rsa-results');
            const weak = data.weak_keys;
            const qrng = data.qrng_keys;

            let html = '<div class="comparison-grid">';
            
            // Weak keys
            html += '<div class="comparison-card weak">';
            html += '<h4>Weak Entropy Keys</h4>';
            html += `<div class="result-item"><strong>Keys Generated:</strong> ${weak.count}</div>`;
            html += `<div class="result-item"><strong>Generation Time:</strong> ${weak.generation_time.toFixed(2)}s</div>`;
            html += `<div class="result-item"><strong>Vulnerable Keys:</strong> <span class="stat-badge danger">${weak.vulnerable_count} / ${weak.count}</span></div>`;
            html += `<div class="result-item"><strong>Scan Time:</strong> ${weak.scan_time.toFixed(2)}s</div>`;
            
            if (weak.findings.length > 0) {
                html += '<div style="margin-top: 15px;"><strong>Example Shared Factors:</strong></div>';
                weak.findings.slice(0, 5).forEach(f => {
                    html += `<div class="result-item">Key[${f.i}] ‚Üî Key[${f.j}]: GCD ~${f.gcd_bits} bits</div>`;
                });
            }
            
            if (weak.top_p_fingerprints.length > 0) {
                html += '<div style="margin-top: 15px;"><strong>Repeated Prime Fingerprints:</strong></div>';
                weak.top_p_fingerprints.forEach(p => {
                    html += `<div class="result-item">${p.fp}: repeated ${p.count} times</div>`;
                });
            }
            
            html += '</div>';

            // QRNG keys
            html += '<div class="comparison-card qrng">';
            html += '<h4>QRNG Entropy Keys</h4>';
            html += `<div class="result-item"><strong>Keys Generated:</strong> ${qrng.count}</div>`;
            html += `<div class="result-item"><strong>Generation Time:</strong> ${qrng.generation_time.toFixed(2)}s</div>`;
            html += `<div class="result-item"><strong>Vulnerable Keys:</strong> <span class="stat-badge success">${qrng.vulnerable_count} / ${qrng.count}</span></div>`;
            html += `<div class="result-item"><strong>Scan Time:</strong> ${qrng.scan_time.toFixed(2)}s</div>`;
            
            if (qrng.vulnerable_count === 0) {
                html += '<div class="alert alert-success" style="margin-top: 15px;">‚úÖ No shared factors found - QRNG entropy provides secure key generation</div>';
            } else if (qrng.findings.length > 0) {
                html += '<div style="margin-top: 15px;"><strong>Unexpected Findings:</strong></div>';
                qrng.findings.slice(0, 5).forEach(f => {
                    html += `<div class="result-item">Key[${f.i}] ‚Üî Key[${f.j}]: GCD ~${f.gcd_bits} bits</div>`;
                });
            }
            
            html += '</div>';
            html += '</div>';

            // Summary
            html += '<div class="result-card">';
            html += '<h3>Security Analysis</h3>';
            html += `<p style="margin-bottom: 15px;">When RSA keys share a prime factor, both keys are mathematically compromised. Weak entropy makes prime reuse likely, especially across devices or VMs started at similar times.</p>`;
            html += `<p><strong>Weak Entropy:</strong> ${weak.vulnerable_count} out of ${weak.count} keys are vulnerable (${((weak.vulnerable_count/weak.count)*100).toFixed(1)}%)</p>`;
            html += `<p><strong>QRNG Entropy:</strong> ${qrng.vulnerable_count} out of ${qrng.count} keys are vulnerable (${((qrng.vulnerable_count/qrng.count)*100).toFixed(1)}%)</p>`;
            html += '</div>';

            results.innerHTML = html;
            results.classList.add('active');
        }

        // QRNG Simple Demo
        async function runQRNGSimple() {
            const qrngB64 = document.getElementById('qrng-b64-simple').value.trim();

            if (!qrngB64) {
                alert('Please provide QRNG base64 data');
                return;
            }

            const loading = document.getElementById('qrng-simple-loading');
            const results = document.getElementById('qrng-simple-results');
            const statusLog = document.getElementById('qrng-simple-status');
            const stepsContainer = document.getElementById('qrng-simple-steps');
            
            // Clear previous logs
            statusLog.innerHTML = '';
            statusLog.style.display = 'block';
            stepsContainer.style.display = 'block';
            
            loading.classList.add('active');
            results.classList.remove('active');

            const steps = ['Parse QRNG Data', 'Derive Key (HKDF-SHA256)', 'Encrypt Message (AES-GCM)', 'Display Results'];
            updateStepIndicator('qrng-simple-steps', steps, 0);

            try {
                addStatusLog('qrng-simple-status', 'Starting QRNG key derivation demo...', 'info');

                updateStepIndicator('qrng-simple-steps', steps, 1);
                addStatusLog('qrng-simple-status', 'Parsing QRNG base64 data (256 bytes)...', 'info');
                await new Promise(r => setTimeout(r, 300));

                updateStepIndicator('qrng-simple-steps', steps, 2);
                addStatusLog('qrng-simple-status', 'Deriving 256-bit key from QRNG data using SHA-256...', 'info');
                addStatusLog('qrng-simple-status', 'Mixing QRNG bytes with OS entropy (32 bytes)...', 'info');
                await new Promise(r => setTimeout(r, 400));

                updateStepIndicator('qrng-simple-steps', steps, 3);
                addStatusLog('qrng-simple-status', 'Generating random nonce (12 bytes)...', 'info');
                addStatusLog('qrng-simple-status', 'Encrypting message with AES-GCM...', 'info');

                const response = await fetch('/api/qrng-simple', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        qrng_b64: qrngB64
                    })
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Demo failed');
                }

                addStatusLog('qrng-simple-status', '‚úì Key derived successfully', 'success');
                addStatusLog('qrng-simple-status', `‚úì Message encrypted successfully (${data.ciphertext_hex.length / 2} bytes)`, 'success');
                addStatusLog('qrng-simple-status', `Key fingerprint: ${data.key_fingerprint}`, 'info');

                updateStepIndicator('qrng-simple-steps', steps, 4);
                addStatusLog('qrng-simple-status', 'Demo completed!', 'success');

                displayQRNGSimpleResults(data);
            } catch (error) {
                addStatusLog('qrng-simple-status', `‚úó Error: ${error.message}`, 'error');
                results.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
                results.classList.add('active');
            } finally {
                loading.classList.remove('active');
            }
        }

        function displayQRNGSimpleResults(data) {
            const results = document.getElementById('qrng-simple-results');

            let html = '<div class="result-card">';
            html += '<h3>Encryption Results</h3>';
            html += `<div class="result-item"><strong>Message:</strong> ${data.message}</div>`;
            html += `<div class="result-item"><strong>Nonce (hex):</strong> <code>${data.nonce_hex}</code></div>`;
            html += `<div class="result-item"><strong>Ciphertext:</strong> <code>${data.ciphertext_preview}</code></div>`;
            html += `<div class="result-item"><strong>Key Fingerprint:</strong> <code>${data.key_fingerprint}</code></div>`;
            html += '</div>';

            html += '<div class="result-card">';
            html += '<h3>Why Brute Force Fails</h3>';
            html += '<ul style="margin-left: 20px; line-height: 1.8;">';
            html += '<li>Weak demo used ~timestamp window (hundreds/thousands of guesses)</li>';
            html += '<li>QRNG seed material provides 256+ bits of unpredictability</li>';
            html += '<li>Even 128-bit min-entropy is already out of reach for brute force</li>';
            html += '<li>The search space is astronomically large (2^256 possibilities)</li>';
            html += '</ul>';
            html += '</div>';

            results.innerHTML = html;
            results.classList.add('active');
        }

        // STS Demo Functions
        async function loadSTSResults() {
            const loading = document.getElementById('sts-loading');
            const results = document.getElementById('sts-results');
            const statusLog = document.getElementById('sts-status');
            const runTests = document.getElementById('sts-run-tests');
            const reportLink = document.getElementById('sts-report-link');
            
            loading.classList.add('active');
            results.style.display = 'none';
            // Keep status log visible - don't hide terminal output
            // statusLog.style.display = 'none';
            if (reportLink) reportLink.style.display = 'none';
            
            try {
                // Check if results are available
                const availableResp = await fetch('/api/sts/available');
                const available = await availableResp.json();
                
                if (!available.available) {
                    results.innerHTML = '<div class="alert alert-info">No STS results found. Use the form below to run new tests.</div>';
                    results.style.display = 'block';
                    runTests.style.display = 'block';
                    loading.classList.remove('active');
                    return;
                }
                
                // Load scorecard
                const response = await fetch('/api/sts/scorecard');
                if (!response.ok) {
                    if (response.status === 404) {
                        results.innerHTML = '<div class="alert alert-info">No scorecard found. Run STS tests to generate one.</div>';
                        results.style.display = 'block';
                        runTests.style.display = 'block';
                        loading.classList.remove('active');
                        return;
                    }
                    throw new Error(`Failed to load scorecard: ${response.statusText}`);
                }
                
                const scorecard = await response.json();
                displaySTSResults(scorecard);
                runTests.style.display = 'block';
                
                // Ensure status log stays visible (don't hide terminal output)
                if (statusLog) {
                    statusLog.style.display = 'block';
                }
                
                // Show report link if results are loaded
                if (reportLink) reportLink.style.display = 'block';
                
            } catch (error) {
                statusLog.innerHTML = `<div class="status-log-entry error">Error: ${error.message}</div>`;
                statusLog.style.display = 'block';
                results.innerHTML = `<div class="alert alert-danger">Error loading STS results: ${error.message}</div>`;
                results.style.display = 'block';
            } finally {
                loading.classList.remove('active');
            }
        }

        function displaySTSResults(scorecard) {
            const results = document.getElementById('sts-results');
            
            const qsePass = scorecard.qse_summary.overall_pass;
            const sysPass = scorecard.system_summary.overall_pass;
            const winner = scorecard.overall.winner;
            const winnerText = winner === 'tie' ? 'Tie' : (winner === 'qse' ? 'QSE' : 'System');
            
            let html = '<div class="result-card" style="background: #e3f2fd; border-left-color: #2196F3; margin-bottom: 20px;">';
            html += `<h3 style="color: #1976D2;">${scorecard.headline_verdict}</h3>`;
            html += '</div>';
            
            // Summary cards
            html += '<div class="comparison-grid" style="margin-bottom: 20px;">';
            
            // QSE card
            html += '<div class="comparison-card ' + (qsePass ? 'qrng' : 'weak') + '">';
            html += '<h4>QSE Entropy</h4>';
            html += `<div class="result-item"><strong>Overall:</strong> <span class="stat-badge ${qsePass ? 'success' : 'danger'}">${qsePass ? 'PASS' : 'FAIL'}</span></div>`;
            html += `<div class="result-item"><strong>Passed Tests:</strong> ${scorecard.qse_summary.passed_tests}/${scorecard.qse_summary.total_tests}</div>`;
            html += `<div class="result-item"><strong>Weakest Test:</strong> ${scorecard.qse_weakest_test.test_name}</div>`;
            html += `<div class="result-item"><strong>Pass Rate:</strong> ${scorecard.qse_weakest_test.pass_rate.toFixed(2)}%</div>`;
            html += '</div>';
            
            // System card
            html += '<div class="comparison-card ' + (sysPass ? 'info' : 'weak') + '">';
            html += '<h4>System Entropy</h4>';
            html += `<div class="result-item"><strong>Overall:</strong> <span class="stat-badge ${sysPass ? 'success' : 'danger'}">${sysPass ? 'PASS' : 'FAIL'}</span></div>`;
            html += `<div class="result-item"><strong>Passed Tests:</strong> ${scorecard.system_summary.passed_tests}/${scorecard.system_summary.total_tests}</div>`;
            html += `<div class="result-item"><strong>Weakest Test:</strong> ${scorecard.system_weakest_test.test_name}</div>`;
            html += `<div class="result-item"><strong>Pass Rate:</strong> ${scorecard.system_weakest_test.pass_rate.toFixed(2)}%</div>`;
            html += '</div>';
            
            // Winner card
            html += '<div class="comparison-card info">';
            html += '<h4>Comparison</h4>';
            html += `<div class="result-item"><strong>Winner:</strong> <span class="stat-badge ${winner === 'qse' ? 'success' : (winner === 'system' ? 'info' : 'neutral')}">${winnerText}</span></div>`;
            html += `<div class="result-item"><strong>QSE Wins:</strong> ${scorecard.wins_by_test.qse}</div>`;
            html += `<div class="result-item"><strong>System Wins:</strong> ${scorecard.wins_by_test.system}</div>`;
            html += `<div class="result-item"><strong>Ties:</strong> ${scorecard.wins_by_test.tie}</div>`;
            html += '</div>';
            
            html += '</div>';
            
            // Comparison table
            html += '<div class="result-card">';
            html += '<h3>Per-Test Comparison</h3>';
            html += '<table style="width: 100%; border-collapse: collapse; margin-top: 15px;">';
            html += '<thead><tr style="background: #f1f5f9;">';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #e2e8f0;">Test</th>';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #e2e8f0;">QSE Pass Rate</th>';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #e2e8f0;">QSE p-value</th>';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #e2e8f0;">System Pass Rate</th>';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #e2e8f0;">System p-value</th>';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #e2e8f0;">Winner</th>';
            html += '</tr></thead><tbody>';
            
            scorecard.comparisons.forEach(comp => {
                const w = comp.winner;
                const wClass = w === 'qse' ? 'winner-qse' : (w === 'system' ? 'winner-system' : 'winner-tie');
                const wLabel = w === 'qse' ? 'QSE' : (w === 'system' ? 'System' : 'Tie');
                const wColor = w === 'qse' ? '#27ae60' : (w === 'system' ? '#3498db' : '#666');
                
                html += '<tr>';
                html += `<td style="padding: 10px; border: 1px solid #e2e8f0;"><strong>${comp.test_name}</strong></td>`;
                html += `<td style="padding: 10px; border: 1px solid #e2e8f0;">${comp.qse.passed}/${comp.qse.total} (${comp.qse.pass_rate.toFixed(2)}%)</td>`;
                html += `<td style="padding: 10px; border: 1px solid #e2e8f0;">${comp.qse.p_value_uniformity.toFixed(6)}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #e2e8f0;">${comp.system.passed}/${comp.system.total} (${comp.system.pass_rate.toFixed(2)}%)</td>`;
                html += `<td style="padding: 10px; border: 1px solid #e2e8f0;">${comp.system.p_value_uniformity.toFixed(6)}</td>`;
                html += `<td style="padding: 10px; border: 1px solid #e2e8f0; color: ${wColor}; font-weight: bold;">${wLabel}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            html += '</div>';
            
            // Key risks section
            html += '<div class="result-card">';
            html += '<h3>Key Risks / Weakest Tests</h3>';
            html += '<table style="width: 100%; border-collapse: collapse; margin-top: 15px;">';
            html += '<thead><tr style="background: #f1f5f9;">';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #e2e8f0;">Source</th>';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #e2e8f0;">Weakest Test</th>';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #e2e8f0;">Pass Rate</th>';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #e2e8f0;">Uniformity p-value</th>';
            html += '<th style="padding: 10px; text-align: left; border: 1px solid #e2e8f0;">Threshold Margin</th>';
            html += '</tr></thead><tbody>';
            
            html += '<tr>';
            html += '<td style="padding: 10px; border: 1px solid #e2e8f0;"><strong>QSE</strong></td>';
            html += `<td style="padding: 10px; border: 1px solid #e2e8f0;">${scorecard.qse_weakest_test.test_name}</td>`;
            html += `<td style="padding: 10px; border: 1px solid #e2e8f0;">${scorecard.qse_weakest_test.passed}/${scorecard.qse_weakest_test.total} (${scorecard.qse_weakest_test.pass_rate.toFixed(2)}%)</td>`;
            html += `<td style="padding: 10px; border: 1px solid #e2e8f0;">${scorecard.qse_weakest_test.p_value_uniformity.toFixed(6)}</td>`;
            html += `<td style="padding: 10px; border: 1px solid #e2e8f0;">${scorecard.qse_weakest_test.passed - scorecard.qse_weakest_test.min_required}</td>`;
            html += '</tr>';
            
            html += '<tr>';
            html += '<td style="padding: 10px; border: 1px solid #e2e8f0;"><strong>System</strong></td>';
            html += `<td style="padding: 10px; border: 1px solid #e2e8f0;">${scorecard.system_weakest_test.test_name}</td>`;
            html += `<td style="padding: 10px; border: 1px solid #e2e8f0;">${scorecard.system_weakest_test.passed}/${scorecard.system_weakest_test.total} (${scorecard.system_weakest_test.pass_rate.toFixed(2)}%)</td>`;
            html += `<td style="padding: 10px; border: 1px solid #e2e8f0;">${scorecard.system_weakest_test.p_value_uniformity.toFixed(6)}</td>`;
            html += `<td style="padding: 10px; border: 1px solid #e2e8f0;">${scorecard.system_weakest_test.passed - scorecard.system_weakest_test.min_required}</td>`;
            html += '</tr>';
            
            html += '</tbody></table>';
            html += '<div style="margin-top: 10px; font-size: 0.9em; color: #666;">';
            html += 'Note: STS evaluates statistical randomness. It does not alone certify cryptographic strength or "quantum resilience."';
            html += '</div>';
            html += '</div>';
            
            results.innerHTML = html;
            results.style.display = 'block';
        }

        async function runSTSTests() {
            const sequences = parseInt(document.getElementById('sts-sequences').value);
            const seqLength = parseInt(document.getElementById('sts-seq-length').value);
            const endpoint = document.getElementById('sts-endpoint').value.trim();
            
            if (!endpoint) {
                alert('QSE endpoint is required');
                return;
            }
            
            const loading = document.getElementById('sts-loading');
            const statusLog = document.getElementById('sts-status');
            const progress = document.getElementById('sts-test-progress');
            const progressBar = document.getElementById('sts-test-progress-bar');
            const progressText = document.getElementById('sts-test-progress-text');
            const results = document.getElementById('sts-results');
            const reportLink = document.getElementById('sts-report-link');
            
            loading.classList.add('active');
            statusLog.innerHTML = '';
            statusLog.style.display = 'block';
            progress.style.display = 'block';
            results.style.display = 'none';
            reportLink.style.display = 'none';
            
            // Helper to update progress
            function updateProgress(percent, text) {
                progressBar.style.width = percent + '%';
                progressBar.textContent = percent + '%';
                progressText.textContent = text;
            }
            
            addStatusLog('sts-status', 'üöÄ Starting NIST STS Pipeline...', 'info');
            addStatusLog('sts-status', `Parameters: ${sequences} sequences, ${seqLength} bits/sequence`, 'info');
            // Calculate estimated time based on sequences (roughly 6-18 seconds per sequence)
            const minMinutes = Math.ceil((sequences * 6) / 60);
            const maxMinutes = Math.ceil((sequences * 18) / 60);
            addStatusLog('sts-status', `‚è≥ Estimated time: ${minMinutes}-${maxMinutes} minutes for ${sequences} sequences. Please wait...`, 'info');
            addStatusLog('sts-status', 'üì° Pipeline is running... All terminal output will be displayed here when complete.', 'info');
            addStatusLog('sts-status', '‚îÄ'.repeat(50), 'info');
            
            try {
                updateProgress(5, 'Starting pipeline script...');
                
                const response = await fetch('/api/sts/run-tests', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        sequences: sequences,
                        seq_length_bits: seqLength,
                        endpoint: endpoint
                    })
                });
                
                // Check response status first
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    throw new Error(errorData.error || `HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                console.log('Response received:', {
                    success: data.success,
                    exit_code: data.exit_code,
                    output_length: data.output ? data.output.length : 0,
                    output_line_count: data.output_line_count || 0,
                    has_error: !!data.error
                });
                
                // Verify we received all output
                if (data.output_line_count && data.output && data.output.length !== data.output_line_count) {
                    console.warn(`Output count mismatch: received ${data.output.length} lines, expected ${data.output_line_count}`);
                }
                
                // Clear the "waiting" message and show actual output
                const statusContainer = document.getElementById('sts-status');
                if (statusContainer && statusContainer.children.length > 5) {
                    // Remove the "waiting" messages (last few entries)
                    const waitingMsg = Array.from(statusContainer.children).find(el => 
                        el.textContent.includes('Output will appear below when available')
                    );
                    if (waitingMsg) waitingMsg.remove();
                }
                
                addStatusLog('sts-status', '‚îÄ'.repeat(50), 'info');
                addStatusLog('sts-status', 'üì• Pipeline completed. Displaying full terminal output...', 'success');
                addStatusLog('sts-status', '‚îÄ'.repeat(50), 'info');
                
                // Show all output from the script
                if (data.output && Array.isArray(data.output)) {
                    console.log('Received output lines:', data.output.length);
                    if (data.output.length > 0) {
                        console.log('First 10 lines:', data.output.slice(0, 10));
                        console.log('Last 10 lines:', data.output.slice(-10));
                    }
                    
                    let displayedCount = 0;
                    
                    // Display ALL lines from the output (including empty lines for formatting)
                    data.output.forEach((line, index) => {
                        // Detect step progress from output
                        if (line.includes('Step 1/8') || line.includes('üì• Step 1/8')) {
                            updateProgress(12, 'Step 1/8: Generating QSE entropy...');
                        } else if (line.includes('Step 2/8') || line.includes('üñ•Ô∏è  Step 2/8')) {
                            updateProgress(25, 'Step 2/8: Generating System entropy...');
                        } else if (line.includes('Step 3/8') || line.includes('üîó Step 3/8')) {
                            updateProgress(37, 'Step 3/8: Combining QSE sequences...');
                        } else if (line.includes('Step 4/8') || line.includes('üîó Step 4/8')) {
                            updateProgress(43, 'Step 4/8: Combining System sequences...');
                        } else if (line.includes('Step 5/8') || line.includes('‚öôÔ∏è  Step 5/8')) {
                            updateProgress(50, 'Step 5/8: Running NIST STS for QSE (5-15 min)...');
                        } else if (line.includes('Step 6/8') || line.includes('‚öôÔ∏è  Step 6/8')) {
                            updateProgress(68, 'Step 6/8: Running NIST STS for System (5-15 min)...');
                        } else if (line.includes('Step 7/8') || line.includes('üìä Step 7/8')) {
                            updateProgress(85, 'Step 7/8: Parsing STS reports...');
                        } else if (line.includes('Step 8/8') || line.includes('üìà Step 8/8')) {
                            updateProgress(93, 'Step 8/8: Generating comparison & scorecard...');
                        } else if (line.includes('PIPELINE COMPLETE') || line.includes('üéâ PIPELINE COMPLETE')) {
                            updateProgress(100, 'üéâ Pipeline Complete!');
                        }
                        
                        // Determine styling based on content
                        let logType = 'info';
                        if (line.includes('‚úÖ') || line.includes('üéâ') || line.includes('Done') || line.includes('complete') || line.includes('Complete')) logType = 'success';
                        else if (line.includes('‚ùå') || line.includes('Error') || line.includes('Failed') || line.includes('ERROR')) logType = 'error';
                        else if (line.includes('‚ö†Ô∏è') || line.includes('Warning') || line.includes('‚ÑπÔ∏è')) logType = 'warning';
                        
                        // Add line to status log without timestamp for cleaner terminal look
                        // Display ALL lines including empty ones to preserve terminal formatting
                        addStatusLog('sts-status', line || ' ', logType, false);
                        displayedCount++;
                    });
                    
                    // Add summary at the end
                    addStatusLog('sts-status', '‚îÄ'.repeat(50), 'info');
                    addStatusLog('sts-status', `‚úÖ Complete terminal output displayed (${displayedCount} lines total)`, 'success');
                    
                    // Ensure we're scrolled to the bottom to see the latest output
                    setTimeout(() => {
                        const statusContainer = document.getElementById('sts-status');
                        if (statusContainer) {
                            statusContainer.scrollTop = statusContainer.scrollHeight;
                        }
                    }, 100);
                    
                    if (data.output.length === 0) {
                        addStatusLog('sts-status', '‚ö†Ô∏è Pipeline returned no output lines', 'warning');
                    }
                } else {
                    console.error('No output array in response:', data);
                    addStatusLog('sts-status', '‚ö†Ô∏è No output received from pipeline (response: ' + JSON.stringify(data).substring(0, 200) + '...)', 'warning');
                }
                
                if (!response.ok || data.error) {
                    throw new Error(data.error || `Pipeline failed with exit code ${data.exit_code}`);
                }
                
                if (data.success) {
                    addStatusLog('sts-status', '‚îÄ'.repeat(50), 'info');
                    addStatusLog('sts-status', '‚úÖ Pipeline completed successfully!', 'success');
                    updateProgress(100, 'üéâ Complete!');
                    
                    // Show report link
                    reportLink.style.display = 'block';
                    
                    // Reload results
                    setTimeout(() => {
                        loadSTSResults();
                    }, 500);
                } else {
                    throw new Error('Pipeline did not generate scorecard');
                }
                
            } catch (error) {
                addStatusLog('sts-status', '‚îÄ'.repeat(50), 'info');
                addStatusLog('sts-status', `‚ùå Error: ${error.message}`, 'error');
                updateProgress(0, 'Failed');
                results.innerHTML = `<div class="alert alert-danger">Error running STS pipeline: ${error.message}</div>`;
                results.style.display = 'block';
            } finally {
                loading.classList.remove('active');
            }
        }

    </script>
</body>
</html>
